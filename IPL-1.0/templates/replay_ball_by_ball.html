<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Match Replay</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; background-color: #1e1e1e; color: #fff; display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; padding: 20px; box-sizing: border-box; }
        .container { width: 100%; max-width: 960px; background: #2c2c2c; padding: 20px; border-radius: 10px; box-shadow: 0 0 20px rgba(0,0,0,0.5); }

        h1, h2, h3 { text-align: center; color: #ffcc00; }
        h1 { font-size: 2em; margin-bottom: 10px; }
        h2 { font-size: 1.6em; margin-bottom: 15px; border-bottom: 1px solid #ffcc00; padding-bottom: 10px;}
        h3 { font-size: 1.2em; margin-bottom: 10px; color: #eee;}
        .section { margin-bottom: 15px; padding: 12px; background-color: #3a3a3a; border-radius: 8px; }
        .section p { margin: 6px 0; font-size: 1em; }
        .section strong { color: #ffcc00; }

        #led-display { text-align: center; padding: 15px; background-color: #111; border-radius: 8px; margin-bottom: 15px; font-size: 1.5em; display: flex; justify-content: space-around; align-items: center; flex-wrap: wrap; }
        #led-display span { padding: 8px 15px; border-radius: 5px; background-color: #000; min-width: 80px; display: inline-block; margin: 5px; }
        .led-default { background-color: #444; color: #fff; }
        .led-runs-0 { background-color: #757575; color: #fff; }
        .led-runs-123 { background-color: #4CAF50; color: white; }
        .led-runs-456 { background-color: #FF9800; color: white; }
        .led-wicket { background-color: #F44336; color: white; }
        .led-extra { background-color: #2196F3; color: white; }

        .player-highlight { font-weight: bold; color: #ffeb3b; }

        .controls { display: flex; justify-content: center; align-items: center; gap: 10px; flex-wrap: wrap; margin-top:15px; }
        .controls button, .controls select { padding: 8px 15px; font-size: 0.9em; cursor: pointer; background-color: #ffcc00; color: #1e1e1e; border: none; border-radius: 5px; transition: background-color 0.3s; }
        .controls button:hover { background-color: #e6b800; }
        .controls button:disabled { background-color: #555; color: #888; cursor: not-allowed; }
        .controls select { background-color: #4a4a4a; color: #fff; border: 1px solid #ffcc00; }

        #last-ball-commentary { font-size: 1.1em; text-align: center; min-height: 25px; padding: 8px; background-color: #4a4a4a; border-radius: 5px;}
        #full-innings-log { max-height: 150px; overflow-y: auto; padding: 8px; background-color: #222; border-radius: 5px; font-size: 0.85em; }
        .log-entry { border-bottom: 1px solid #444; padding: 5px 0; }
        .log-entry:last-child { border-bottom: none; }

        .win-message { text-align: center; font-size: 1.5em; color: #4CAF50; font-weight: bold; padding: 15px; background-color: #dff0d8; border: 1px solid #4CAF50; border-radius: 5px; color:#3c763d;}
        .hidden { display: none; }
        a { color: #ffcc00; text-decoration: none; }
        a:hover { text-decoration: underline;}
        .team-logo-pbs { width: 24px; height: 24px; margin-right: 8px; vertical-align: middle; border-radius: 50%; background-color: #fff; padding:1px; }
        .team-display { display: flex; align-items: center; margin-bottom: 5px;}
        .team-display .name {font-size: 1.1em; font-weight:bold;}
        .team-display .score-details {font-size: 1em; margin-left:8px;}
    </style>
</head>
<body>
    <div class="container">
        <h1>Match Replay</h1>
        <p style="text-align:center;"><a href="{{ url_for('index') }}">New Match / Select Teams</a></p>

        <div id="tossDisplay" class="section"></div>

        <div id="led-display">
            <span>Ball: <span id="led-ball-number">0.0</span></span>
            <span>Outcome: <span id="led-ball-outcome" class="led-default">---</span></span>
            <span>Score: <span id="led-current-total">0/0</span></span>
        </div>

        <div class="section score-info">
            <h2>Scoreboard</h2>
            <div class="team-display batting-team-display">
                <img src="" alt="Batting Team Logo" class="team-logo-pbs" id="battingTeamLogo">
                <div>
                    <span class="name" id="battingTeamName">N/A</span>
                    <span class="score-details">Score: <span id="currentScore">0</span>/<span id="currentWickets">0</span> (<span id="currentOvers">0.0</span> Overs)</span>
                </div>
            </div>
            <div class="team-display bowling-team-display" style="margin-top:8px;">
                <img src="" alt="Bowling Team Logo" class="team-logo-pbs" id="bowlingTeamLogo">
                 <span class="name" id="bowlingTeamName">N/A</span>
            </div>
            <div id="targetInfo" class="hidden" style="margin-top:12px;">
                <p><strong>Target:</strong> <span id="targetScore">0</span></p>
                <p><strong>Needed:</strong> <span id="runsNeeded">0</span> runs from <span id="ballsRemaining">0</span> balls</p>
            </div>
        </div>

        <div class="section players-info">
            <h3>Current Players</h3>
            <p>On Strike: <span id="batsman-onstrike" class="player-highlight">N/A</span></p>
            <p>Non-Striker: <span id="batsman-nonstrike">N/A</span></p>
            <p>Current Bowler: <span id="current-bowler">N/A</span></p>
        </div>

        <div id="winMessageContainer" class="win-message hidden"></div>

        <div class="controls section">
            <button id="nextBallBtn">Next Ball</button>
            <select id="simSpeed">
                <option value="2000">Slow (2s)</option>
                <option value="1000" selected>Medium (1s)</option>
                <option value="500">Fast (0.5s)</option>
                <option value="100">Very Fast (0.1s)</option>
            </select>
            <button id="startAutoPlayBtn">Auto-Play</button>
            <button id="pauseAutoPlayBtn" class="hidden">Pause</button>
        </div>

        <div class="section commentary-box">
            <h3>Commentary</h3>
            <div id="last-ball-commentary">Match Replay Ready. Click Next Ball or Auto-Play.</div>
        </div>

        <div class="section full-log-box">
            <h3>Full Log (Current Innings)</h3>
            <div id="full-innings-log"></div>
        </div>
    </div>

    <script>
        const fullMatchData = {{ full_match_data | tojson }};

        const tossDisplayEl = document.getElementById('tossDisplay');
        const ledBallNumEl = document.getElementById('led-ball-number');
        const ledOutcomeEl = document.getElementById('led-ball-outcome');
        const ledScoreEl = document.getElementById('led-current-total');

        const battingTeamNameEl = document.getElementById('battingTeamName');
        const battingTeamLogoEl = document.getElementById('battingTeamLogo');
        const currentScoreEl = document.getElementById('currentScore');
        const currentWicketsEl = document.getElementById('currentWickets');
        const currentOversEl = document.getElementById('currentOvers');

        const bowlingTeamNameEl = document.getElementById('bowlingTeamName');
        const bowlingTeamLogoEl = document.getElementById('bowlingTeamLogo');

        const targetInfoEl = document.getElementById('targetInfo');
        const targetScoreEl = document.getElementById('targetScore');
        const runsNeededEl = document.getElementById('runsNeeded');
        const ballsRemainingEl = document.getElementById('ballsRemaining');

        const onStrikeBatsmanEl = document.getElementById('batsman-onstrike');
        const nonStrikeBatsmanEl = document.getElementById('batsman-nonstrike');
        const currentBowlerEl = document.getElementById('current-bowler');

        const winMessageContainerEl = document.getElementById('winMessageContainer');
        const nextBallBtn = document.getElementById('nextBallBtn');
        const simSpeedSelect = document.getElementById('simSpeed');
        const startAutoPlayBtn = document.getElementById('startAutoPlayBtn');
        const pauseAutoPlayBtn = document.getElementById('pauseAutoPlayBtn');

        const lastBallCommentaryEl = document.getElementById('last-ball-commentary');
        const fullInningsLogEl = document.getElementById('full-innings-log');

        let innings1Log = fullMatchData.innings1_log || [];
        let innings2Log = fullMatchData.innings2_log || [];
        let ballEvents = [];

        let currentInningsNumber = 1;
        let currentBallOverallIndex = -1;

        let runningScoreInInnings = 0;
        let runningWicketsInInnings = 0;
        let runningLegalBallsInInnings = 0;
        let targetToChase = 0;
        let autoPlayInterval = null;

        function formatOver(legalBalls) {
            if (legalBalls === undefined || legalBalls === null || legalBalls < 0) return "0.0";
            const overs = Math.floor(legalBalls / 6);
            const ballsInOver = legalBalls % 6;
            return `${overs}.${ballsInOver}`;
        }

        function parseEventStringForLed(eventString, ballData) {
            let outcomeText = " ";
            let outcomeClass = "led-runs-0";

            const eventLower = eventString.toLowerCase();

            if (eventLower.includes(" wicket") || eventLower.includes(" w ")) { outcomeClass = 'led-wicket'; outcomeText = "WICKET!"; }
            else if (eventLower.includes("wide")) { outcomeClass = 'led-extra'; outcomeText = "WIDE"; }
            else if (eventLower.includes("six!") || eventLower.includes(" 6 run")) { outcomeClass = 'led-runs-456'; outcomeText = "6"; }
            else if (eventLower.includes(" 4 run")) { outcomeClass = 'led-runs-456'; outcomeText = "4"; }
            else if (eventLower.includes(" 1 run")) { outcomeClass = 'led-runs-123'; outcomeText = "1"; }
            else if (eventLower.includes(" 2 run")) { outcomeClass = 'led-runs-123'; outcomeText = "2"; }
            else if (eventLower.includes(" 3 run")) { outcomeClass = 'led-runs-123'; outcomeText = "3"; }
            else if (eventLower.includes(" 0 run") || eventLower.endsWith(" 0")) { outcomeClass = 'led-runs-0'; outcomeText = "0"; }
            else { outcomeClass = 'led-default'; outcomeText = '...'; }

            return { text: outcomeText, cssClass: outcomeClass };
        }

        function updateUIDisplay(logEntry) {
            runningScoreInInnings = logEntry.runs;
            runningWicketsInInnings = logEntry.wickets;
            runningLegalBallsInInnings = logEntry.balls;

            currentScoreEl.textContent = runningScoreInInnings;
            currentWicketsEl.textContent = runningWicketsInInnings;
            const oversStr = formatOver(runningLegalBallsInInnings);
            currentOversEl.textContent = oversStr;
            ledScoreEl.textContent = `${runningScoreInInnings}/${runningWicketsInInnings}`;

            const parsedLedInfo = parseEventStringForLed(logEntry.event, logEntry);
            ledOutcomeEl.textContent = parsedLedInfo.text;
            ledOutcomeEl.className = parsedLedInfo.cssClass;

            const ballNumMatch = logEntry.event.match(/^(\d+\.\d+)/);
            ledBallNumEl.textContent = ballNumMatch ? ballNumMatch[1] : oversStr;

            onStrikeBatsmanEl.textContent = logEntry.batsman || logEntry.batter1 || 'N/A';
            if (logEntry.batter1 === (logEntry.batsman || logEntry.batter1) ) {
                nonStrikeBatsmanEl.textContent = logEntry.batter2 || 'N/A';
            } else {
                nonStrikeBatsmanEl.textContent = logEntry.batter1 || 'N/A';
            }
            currentBowlerEl.textContent = logEntry.bowler || 'N/A';

            lastBallCommentaryEl.textContent = logEntry.event;
            const logEntryDiv = document.createElement('div');
            logEntryDiv.classList.add('log-entry');
            logEntryDiv.textContent = logEntry.event;
            fullInningsLogEl.appendChild(logEntryDiv);
            fullInningsLogEl.scrollTop = fullInningsLogEl.scrollHeight;

            if (currentInningsNumber === 2 && targetToChase > 0) {
                targetInfoEl.classList.remove('hidden');
                const needed = Math.max(0, targetToChase - runningScoreInInnings);
                const remainingBalls = Math.max(0, 120 - runningLegalBallsInInnings);
                runsNeededEl.textContent = needed;
                ballsRemainingEl.textContent = remainingBalls;
            }
        }

        function setupInningsUI(inningsNo) {
            const batTeamCode = inningsNo === 1 ? fullMatchData.innings1_bat_team : fullMatchData.innings2_bat_team;
            const bowlTeamCode = inningsNo === 1 ? fullMatchData.innings2_bat_team : fullMatchData.innings1_bat_team;

            let batTeamData = (batTeamCode.toLowerCase() === fullMatchData.team1_code.toLowerCase()) ? fullMatchData.team1_data : fullMatchData.team2_data;
            let bowlTeamData = (bowlTeamCode.toLowerCase() === fullMatchData.team1_code.toLowerCase()) ? fullMatchData.team1_data : fullMatchData.team2_data;

            battingTeamNameEl.textContent = batTeamData.fullName || batTeamCode;
            battingTeamLogoEl.src = batTeamData.logo || '';
            battingTeamLogoEl.alt = (batTeamData.name || batTeamCode) + ' Logo';

            bowlingTeamNameEl.textContent = bowlTeamData.fullName || bowlTeamCode;
            bowlingTeamLogoEl.src = bowlTeamData.logo || '';
            bowlingTeamLogoEl.alt = (bowlTeamData.name || bowlTeamCode) + ' Logo';

            fullInningsLogEl.innerHTML = `<h3>Innings ${inningsNo}</h3>`;
            lastBallCommentaryEl.textContent = `Start of Innings ${inningsNo}.`;
            currentScoreEl.textContent = "0"; currentWicketsEl.textContent = "0"; currentOversEl.textContent = "0.0";
            ledScoreEl.textContent = "0/0"; ledBallNumEl.textContent = "0.0"; ledOutcomeEl.className = "led-default"; ledOutcomeEl.textContent = "---";

            if (inningsNo === 2) {
                targetToChase = fullMatchData.innings1_runs + 1;
                targetScoreEl.textContent = targetToChase;
                runsNeededEl.textContent = targetToChase; // Initially
                ballsRemainingEl.textContent = 120;    // Initially
                targetInfoEl.classList.remove('hidden');
            } else {
                targetInfoEl.classList.add('hidden');
            }
        }

        function initializeReplay() {
            ballEvents = innings1Log.concat(innings2Log);
            if (ballEvents.length === 0 && (!innings1Log || innings1Log.length === 0)) { // Check if both are effectively empty
                lastBallCommentaryEl.textContent = "No ball-by-ball data available for this match.";
                disableControls();
                winMessageContainerEl.textContent = fullMatchData.win_msg || "Match data incomplete.";
                winMessageContainerEl.classList.remove('hidden');
                return;
            }
            tossDisplayEl.textContent = fullMatchData.toss_msg;
            currentInningsNumber = 1;
            currentBallOverallIndex = -1;
            runningScoreInInnings = 0; runningWicketsInInnings = 0; runningLegalBallsInInnings = 0;
            setupInningsUI(1);
            winMessageContainerEl.classList.add('hidden');
            nextBallBtn.disabled = false;
            startAutoPlayBtn.disabled = false;
            pauseAutoPlayBtn.classList.add('hidden'); // Ensure pause is hidden initially
            simSpeedSelect.disabled = false;
        }

        function handleEndOfMatch() {
            winMessageContainerEl.textContent = fullMatchData.win_msg || "Match Concluded.";
            winMessageContainerEl.classList.remove('hidden');
            disableControls();
        }

        function disableControls() {
            nextBallBtn.disabled = true;
            startAutoPlayBtn.disabled = true;
            pauseAutoPlayBtn.classList.add('hidden');
            simSpeedSelect.disabled = true;
            if (autoPlayInterval) clearInterval(autoPlayInterval); autoPlayInterval = null;
        }

        function handleNextBall() {
            if (winMessageContainerEl.classList.contains('hidden') === false) return; // Match already ended

            currentBallOverallIndex++;

            if (currentBallOverallIndex >= ballEvents.length) {
                handleEndOfMatch();
                return;
            }

            let currentBallEventData = ballEvents[currentBallOverallIndex];

            let previousInningsNumber = currentInningsNumber;
            if (currentInningsNumber === 1 && currentBallOverallIndex >= innings1Log.length) {
                if (innings2Log.length > 0) { // Only switch if there's a second innings log
                    currentInningsNumber = 2;
                } else { // No second innings log, means match ended after 1st.
                    handleEndOfMatch();
                    return;
                }
            }

            if (currentInningsNumber !== previousInningsNumber) {
                setupInningsUI(2);
                // runningLegalBallsInInnings will be set by currentBallEventData.balls from the first ball of 2nd innings
            }

            updateUIDisplay(currentBallEventData);

            // Check for win conditions after updating UI
            if (currentInningsNumber === 2 && targetToChase > 0 && runningScoreInInnings >= targetToChase) {
                handleEndOfMatch();
            } else if (currentBallOverallIndex === ballEvents.length - 1) { // Last ball of all available logs
                handleEndOfMatch();
            }
        }

        nextBallBtn.addEventListener('click', handleNextBall);
        startAutoPlayBtn.addEventListener('click', () => {
            if (winMessageContainerEl.classList.contains('hidden')) {
                startAutoPlayBtn.classList.add('hidden');
                pauseAutoPlayBtn.classList.remove('hidden');
                nextBallBtn.disabled = true; simSpeedSelect.disabled = true;
                const speed = parseInt(simSpeedSelect.value, 10);

                function autoPlay() {
                    if (!winMessageContainerEl.classList.contains('hidden')) { // Check if game ended by handleNextBall
                        clearInterval(autoPlayInterval); autoPlayInterval = null;
                        pauseAutoPlayBtn.classList.add('hidden'); startAutoPlayBtn.classList.remove('hidden');
                        disableControls(); // Ensure controls are fully disabled
                        return;
                    }
                    handleNextBall();
                }
                autoPlay(); // Call once immediately
                if (!winMessageContainerEl.classList.contains('hidden')) return;
                autoPlayInterval = setInterval(autoPlay, speed);
            }
        });
        pauseAutoPlayBtn.addEventListener('click', () => {
            clearInterval(autoPlayInterval); autoPlayInterval = null;
            pauseAutoPlayBtn.classList.add('hidden');
            startAutoPlayBtn.classList.remove('hidden');
            if (!winMessageContainerEl.classList.contains('hidden')) {
                nextBallBtn.disabled = true; startAutoPlayBtn.disabled = true;
            } else {
                nextBallBtn.disabled = false; startAutoPlayBtn.disabled = false;
            }
            simSpeedSelect.disabled = false;
        });

        initializeReplay();
    </script>
</body>
</html>
